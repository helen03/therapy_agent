# LLM é›†æˆéƒ¨ç½²æŒ‡å—

æœ¬æ–‡æ¡£æä¾›äº†å°† Therapy Agent ä»åŸºäºè§„åˆ™çš„ç³»ç»Ÿè¿ç§»åˆ°å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰çš„å®Œæ•´éƒ¨ç½²æŒ‡å—ã€‚

## ğŸš€ ä¸»è¦å˜æ›´

### æ¶æ„å˜æ›´
1. **ç§»é™¤äº†è§„åˆ™å¼•æ“**ï¼šä¸å†ä½¿ç”¨ `rule_based_model.py` çš„å†³ç­–é€»è¾‘
2. **æ–°å¢ LLM æœåŠ¡**ï¼š`LLMTherapyService` å¤„ç†æ‰€æœ‰æ²»ç–—å¯¹è¯
3. **ç»Ÿä¸€çš„ API ç«¯ç‚¹**ï¼šæ‰€æœ‰å®¢æˆ·ç«¯ä½¿ç”¨ç›¸åŒçš„èŠå¤©æ¥å£
4. **å¢å¼ºçš„æƒ…æ„Ÿåˆ†æ**ï¼šå®æ—¶æƒ…ç»ªæ£€æµ‹å’Œå±æœºå¤„ç†

### æ–°å¢åŠŸèƒ½
1. **æ™ºèƒ½å¯¹è¯**ï¼šåŸºäº LLM çš„è‡ªç„¶è¯­è¨€å¤„ç†
2. **æƒ…æ„Ÿåˆ†æ**ï¼šå®æ—¶æƒ…ç»ªè¯†åˆ«å’Œå“åº”
3. **å±æœºå¹²é¢„**ï¼šè‡ªåŠ¨æ£€æµ‹å’Œå¤„ç†å±æœºæƒ…å†µ
4. **ä¸Šä¸‹æ–‡è®°å¿†**ï¼šè·¨ä¼šè¯çš„å¯¹è¯å†å²ç®¡ç†
5. **å¤šæ¨¡æ€æ”¯æŒ**ï¼šæ”¯æŒæ–‡æœ¬ã€æƒ…æ„Ÿå’Œä¸Šä¸‹æ–‡è¾“å…¥

## ğŸ“‹ éƒ¨ç½²æ­¥éª¤

### 1. ç¯å¢ƒé…ç½®

```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
export OPENAI_API_KEY="your-openai-api-key"  # å¦‚æœä½¿ç”¨ OpenAI
export LLM_MODEL_TYPE="huggingface"         # æˆ– "openai"
export LLM_MODEL_NAME="gpt2"                # æˆ–å…¶ä»–æ¨¡å‹åç§°

# æˆ–è€…åˆ›å»º .env æ–‡ä»¶
echo "OPENAI_API_KEY=your-openai-api-key" > backend/.env
echo "LLM_MODEL_TYPE=huggingface" >> backend/.env
echo "LLM_MODEL_NAME=gpt2" >> backend/.env
```

### 2. ä¾èµ–å®‰è£…

```bash
# å®‰è£…æ–°çš„ä¾èµ–
cd backend
pip install -r requirements.txt

# å¦‚æœéœ€è¦ OpenAI æ”¯æŒ
pip install openai

# å¦‚æœéœ€è¦å…¶ä»–æ¨¡å‹
pip install transformers torch
```

### 3. æ•°æ®åº“è¿ç§»ï¼ˆå¯é€‰ï¼‰

```bash
# å¦‚æœæ•°æ®åº“ç»“æ„æœ‰å˜åŒ–
flask db migrate -m "add_llm_support"
flask db upgrade
```

### 4. å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨åç«¯æœåŠ¡
flask run --host=0.0.0.0 --port=5000

# æˆ–è€…ä½¿ç”¨ç”Ÿäº§æ¨¡å¼
gunicorn -w 4 -b 0.0.0.0:5000 "backend:create_app()"
```

### 5. æµ‹è¯•é›†æˆ

```bash
# è¿è¡Œé›†æˆæµ‹è¯•
python test_llm_integration.py

# æµ‹è¯• API ç«¯ç‚¹
curl -X POST http://localhost:5000/api/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "ä½ å¥½ï¼Œæˆ‘ä»Šå¤©å¿ƒæƒ…ä¸å¥½", "session_id": "test", "user_id": "test"}'
```

## ğŸ”§ é…ç½®é€‰é¡¹

### LLM æ¨¡å‹é…ç½®

```python
# æ”¯æŒçš„æ¨¡å¼
MODEL_TYPES = ["huggingface", "openai"]

# HuggingFace æ¨¡å‹é€‰é¡¹
HUGGINGFACE_MODELS = ["gpt2", "microsoft/DialoGPT-medium", "facebook/blenderbot-400M-distill"]

# OpenAI æ¨¡å‹é€‰é¡¹  
OPENAI_MODELS = ["gpt-3.5-turbo", "gpt-4"]
```

### ç¯å¢ƒå˜é‡

| å˜é‡å | æè¿° | é»˜è®¤å€¼ |
|--------|------|--------|
| `OPENAI_API_KEY` | OpenAI API å¯†é’¥ | æ—  |
| `LLM_MODEL_TYPE` | æ¨¡å‹ç±»å‹ | `huggingface` |
| `LLM_MODEL_NAME` | æ¨¡å‹åç§° | `gpt2` |
| `MAX_RESPONSE_LENGTH` | æœ€å¤§å“åº”é•¿åº¦ | `300` |
| `TEMPERATURE` | ç”Ÿæˆæ¸©åº¦ | `0.7` |

## ğŸ“± å®¢æˆ·ç«¯æ›´æ–°

### Android åº”ç”¨
- æ›´æ–°äº† API ç«¯ç‚¹è·¯å¾„
- å¢åŠ äº†é”™è¯¯å¤„ç†
- æ”¯æŒæ–°çš„å“åº”æ ¼å¼

### å¾®ä¿¡å°ç¨‹åº  
- ä½¿ç”¨ç»Ÿä¸€çš„ `/api/chat` ç«¯ç‚¹
- æ”¯æŒç”¨æˆ· ID å’Œä¼šè¯ç®¡ç†
- å¢å¼ºçš„é”™è¯¯å¤„ç†

### Web å‰ç«¯
- ä¿æŒå‘åå…¼å®¹
- è‡ªåŠ¨ä½¿ç”¨æ–°çš„ LLM æœåŠ¡
- æ”¯æŒæƒ…æ„Ÿæ˜¾ç¤ºé€‰é¡¹

## ğŸ§ª API ç«¯ç‚¹

### ä¸»è¦ç«¯ç‚¹

1. **èŠå¤©ç«¯ç‚¹** `POST /api/chat`
   ```json
   {
     "message": "ç”¨æˆ·æ¶ˆæ¯",
     "session_id": "ä¼šè¯ID", 
     "user_id": "ç”¨æˆ·ID"
   }
   ```

2. **ç§»åŠ¨ç™»å½•** `POST /api/mobile_login`
   ```json
   {
     "username": "ç”¨æˆ·å",
     "avatar": "å¤´åƒURL"
   }
   ```

3. **ä¼šè¯æ›´æ–°** `POST /api/update_session` (å‘åå…¼å®¹)

### å“åº”æ ¼å¼

```json
{
  "success": true,
  "response": "AIå›å¤å†…å®¹",
  "options": ["é€‰é¡¹1", "é€‰é¡¹2", "é€‰é¡¹3"],
  "emotion": "happy",
  "requires_followup": false,
  "session_id": "ä¼šè¯ID",
  "user_id": "ç”¨æˆ·ID"
}
```

## ğŸ” ç›‘æ§å’Œæ—¥å¿—

### æ—¥å¿—é…ç½®

```python
# åœ¨ backend/__init__.py ä¸­é…ç½®
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s %(levelname)s %(name)s : %(message)s"
)
```

### å…³é”®ç›‘æ§æŒ‡æ ‡

1. **LLM å“åº”æ—¶é—´**ï¼šç›‘æ§ç”Ÿæˆå»¶è¿Ÿ
2. **æƒ…æ„Ÿåˆ†æå‡†ç¡®ç‡**ï¼šè·Ÿè¸ªæƒ…ç»ªè¯†åˆ«
3. **å±æœºæ£€æµ‹**ï¼šè®°å½•å±æœºå¹²é¢„äº‹ä»¶
4. **API é”™è¯¯ç‡**ï¼šç›‘æ§æœåŠ¡å¥åº·çŠ¶æ€

## ğŸš¨ å±æœºå¤„ç†

### è‡ªåŠ¨æ£€æµ‹
ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹ä»¥ä¸‹å±æœºæƒ…å†µï¼š
- è‡ªæ€å€¾å‘è¡¨è¾¾
- ä¸¥é‡æƒ…ç»ªå›°æ‰°  
- ç´§æ€¥æ±‚åŠ©ä¿¡å·

### å“åº”æµç¨‹
1. æƒ…æ„Ÿåˆ†ææ£€æµ‹å±æœºä¿¡å·
2. ç”Ÿæˆç´§æ€¥å“åº”å†…å®¹
3. æä¾›å±æœºèµ„æºä¿¡æ¯
4. è®°å½•å±æœºäº‹ä»¶æ—¥å¿—

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### ç¼“å­˜ç­–ç•¥
```python
# å¯¹è¯å†å²ç¼“å­˜
self.conversation_histories: Dict[str, List[Dict]] = {}

# æ¨¡å‹ç¼“å­˜  
_llm_instance = None  # å•ä¾‹æ¨¡å¼
```

### æ‰¹å¤„ç†ä¼˜åŒ–
- æƒ…æ„Ÿåˆ†ææ‰¹å¤„ç†
- å“åº”ç”Ÿæˆä¼˜åŒ–
- å†…å­˜ç®¡ç†ä¼˜åŒ–

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **LLM åˆå§‹åŒ–å¤±è´¥**
   ```bash
   # æ£€æŸ¥æ¨¡å‹æ–‡ä»¶
   # æ£€æŸ¥ç½‘ç»œè¿æ¥
   # éªŒè¯ API å¯†é’¥
   ```

2. **å“åº”æ—¶é—´è¿‡é•¿**
   ```bash
   # è°ƒæ•´ max_length å‚æ•°
   # ä½¿ç”¨æ›´å°çš„æ¨¡å‹
   # å¯ç”¨ç¼“å­˜
   ```

3. **æƒ…æ„Ÿåˆ†æä¸å‡†ç¡®**
   ```bash
   # æ£€æŸ¥æƒ…æ„Ÿåˆ†ææ¨¡å‹
   # éªŒè¯è¾“å…¥æ–‡æœ¬é¢„å¤„ç†
   ```

### è°ƒè¯•æ¨¡å¼

```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—
export LOG_LEVEL=DEBUG

# æµ‹è¯•å•ä¸ªåŠŸèƒ½
python -c "from backend.models.llm_integration import get_llm; llm = get_llm(); print(llm.analyze_emotion('æµ‹è¯•æ–‡æœ¬'))"
```

## ğŸ¯ ç”Ÿäº§éƒ¨ç½²

### Docker éƒ¨ç½²

```dockerfile
# ä½¿ç”¨å®˜æ–¹ Python é•œåƒ
FROM python:3.9-slim

# å®‰è£…ä¾èµ–
COPY requirements.txt .
RUN pip install -r requirements.txt

# å¤åˆ¶ä»£ç 
COPY . .

# å¯åŠ¨æœåŠ¡
CMD ["gunicorn", "-w", "4", "-b", "0.0.0.0:5000", "backend:create_app()"]
```

### Kubernetes éƒ¨ç½²

```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: therapy-agent
spec:
  replicas: 3
  template:
    spec:
      containers:
      - name: therapy-agent
        image: therapy-agent:latest
        env:
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: therapy-secrets
              key: openai-api-key
```

## ğŸ“ˆ æ€§èƒ½åŸºå‡†

### é¢„æœŸæ€§èƒ½
- **å“åº”æ—¶é—´**: < 2ç§’ (æœ¬åœ°æ¨¡å‹), < 1ç§’ (OpenAI)
- **å¹¶å‘æ”¯æŒ**: 50+ å¹¶å‘ç”¨æˆ·
- **å‡†ç¡®ç‡**: 85%+ æƒ…æ„Ÿè¯†åˆ«å‡†ç¡®ç‡

### ç›‘æ§æŒ‡æ ‡
- CPU ä½¿ç”¨ç‡
- å†…å­˜ä½¿ç”¨é‡  
- API å“åº”æ—¶é—´
- é”™è¯¯ç‡

## ğŸ”® æœªæ¥æ‰©å±•

### è®¡åˆ’åŠŸèƒ½
1. **å¤šè¯­è¨€æ”¯æŒ**ï¼šå›½é™…åŒ–å“åº”ç”Ÿæˆ
2. **è¯­éŸ³äº¤äº’**ï¼šè¯­éŸ³è¾“å…¥è¾“å‡ºé›†æˆ
3. **ä¸ªæ€§åŒ–æ¨¡å‹**ï¼šç”¨æˆ·ç‰¹å®šçš„å¾®è°ƒ
4. **å¤šæ¨¡æ€è¾“å…¥**ï¼šæ”¯æŒå›¾åƒå’Œè¯­éŸ³æƒ…æ„Ÿåˆ†æ

### æŠ€æœ¯è·¯çº¿
1. **æ¨¡å‹ä¼˜åŒ–**ï¼šé‡åŒ–ã€è’¸é¦ã€å‰ªæ
2. **ç¼“å­˜ä¼˜åŒ–**ï¼šå‘é‡æ•°æ®åº“é›†æˆ
3. **è¾¹ç¼˜è®¡ç®—**ï¼šç«¯ä¾§æ¨¡å‹éƒ¨ç½²
4. **è”é‚¦å­¦ä¹ **ï¼šéšç§ä¿æŠ¤è®­ç»ƒ

---

**æ³¨æ„**ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰ï¼Œè¯·è¿›è¡Œå……åˆ†çš„æµ‹è¯•å’ŒéªŒè¯ï¼Œç¡®ä¿æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œå¹¶æ»¡è¶³æ€§èƒ½è¦æ±‚ã€‚