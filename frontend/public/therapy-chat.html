<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindGuide 治疗助手</title>
    <style>
        /* 全局样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: #f5f7f9;
            color: #495057;
            line-height: 1.6;
        }

        /* 头部样式 */
        .app-header {
            background: linear-gradient(135deg, #6673f6 0%, #55bff7 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .app-header h1 {
            font-size: 1.8rem;
            font-weight: 600;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .tools-toggle, .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .tools-toggle:hover, .logout-btn:hover {
            background: white;
            color: #6673f6;
        }

        .user-profile {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 20px;
        }

        .user-avatar {
            background: white;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 0.8rem;
            color: #6673f6;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .user-status {
            font-size: 0.75rem;
            opacity: 0.9;
        }

        /* 内容区域样式 */
        .app-content {
            display: flex;
            height: calc(100vh - 80px);
        }

        /* 工具侧边栏样式 */
        .tools-sidebar {
            width: 280px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            padding: 1.5rem;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        .tools-sidebar h3 {
            color: #495057;
            margin-bottom: 1.5rem;
            font-size: 1.2rem;
            border-bottom: 2px solid #6673f6;
            padding-bottom: 0.5rem;
        }

        .tool-section {
            margin-bottom: 2rem;
        }

        .tool-section h4 {
            color: #6c757d;
            margin-bottom: 0.8rem;
            font-size: 0.95rem;
            font-weight: 600;
        }

        /* 工具按钮样式 */
        .tool-btn {
            padding: 0.5rem 1rem;
            margin: 0.3rem 0;
            border: none;
            background: linear-gradient(135deg, #6673f6 0%, #55bff7 100%);
            color: white;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            width: 100%;
            text-align: left;
        }

        /* 应用容器样式 */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }

        /* 工具页面容器样式 */
        .tool-page-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            padding: 1rem;
            box-sizing: border-box;
        }

        .tool-page-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .back-btn {
            display: flex;
            align-items: center;
            background: none;
            border: none;
            color: #6673f6;
            cursor: pointer;
            font-size: 1rem;
            margin-right: 1rem;
        }

        .tool-page-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1a202c;
        }

        .tool-page-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: #f9fafb;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        h2 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #1a202c;
        }

        h3 {
            font-size: 1.25rem;
            font-weight: bold;
            margin: 1rem 0 0.5rem;
            color: #1a202c;
        }

        p {
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        ul, ol {
            margin-bottom: 1rem;
            padding-left: 1.5rem;
        }

        li {
            margin-bottom: 0.5rem;
        }

        .hidden {
            display: none;
        }

        .tool-btn:hover {
            background: #6673f6;
            color: white;
            border-color: #6673f6;
            transform: translateY(-1px);
        }

        /* 聊天容器样式 */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
            margin: 1rem;
        }

        .chat-header {
            background: linear-gradient(135deg, #6673f6 0%, #55bff7 100%);
            color: white;
            padding: 1rem;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .chat-messages {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .chat-message {
            margin-bottom: 1.5rem;
            max-width: 70%;
            padding: 1rem;
            border-radius: 15px;
            position: relative;
            word-break: break-word;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .loading .typing-indicator {
            display: flex;
            gap: 5px;
        }

        .loading .typing-indicator span {
            width: 8px;
            height: 8px;
            background-color: #6673f6;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
        }

        .loading .typing-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading .typing-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .error {
            background-color: #ffebee;
            color: #b71c1c;
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-bottom: 0.3rem;
        }

        .bot-message .message-time {
            color: #6c757d;
        }

        .user-message .message-time {
            color: rgba(255,255,255,0.8);
        }

        .bot-message {
            background-color: #f0f2f7;
            color: #4A4A4A;
            margin-right: auto;
            border-top-left-radius: 0;
        }

        .user-message {
            background: linear-gradient(135deg, #6673f6 0%, #55bff7 100%);
            color: white;
            margin-left: auto;
            border-top-right-radius: 0;
        }

        .chat-input-container {
            display: flex;
            padding: 1rem;
            border-top: 1px solid #e9ecef;
        }

        .chat-input {
            flex: 1;
            padding: 0.8rem 1rem;
            border: 1px solid #dee2e6;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .chat-input:focus {
            border-color: #6673f6;
        }

        .chat-btn-send {
            background: linear-gradient(135deg, #6673f6 0%, #55bff7 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            margin-left: 0.8rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s ease;
        }

        .chat-btn-send:hover {
            transform: scale(1.05);
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .app-header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }

            .app-header h1 {
                font-size: 1.4rem;
            }

            .app-content {
                flex-direction: column;
            }

            .tools-sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e9ecef;
                max-height: 300px;
            }

            .chat-container {
                margin: 0.5rem;
                height: calc(100vh - 280px);
            }

            .chat-message {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <div class="app-header">
        <h1>MindGuide 治疗助手</h1>
        <div class="header-controls">
            <div class="user-profile">
                <div class="user-avatar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                </div>
                <div class="user-details">
                    <div class="user-name">张明</div>
                    <div class="user-status">在线</div>
                </div>
            </div>
            <button class="tools-toggle" id="toolsToggle">显示工具</button>
            <button class="logout-btn">退出登录</button>
        </div>
    </div>

    <div class="app-content">
        <div class="tools-sidebar" id="toolsSidebar">
            <h3>治疗工具</h3>
            <div class="tool-section">
                <h4>情绪调节</h4>
                <button class="tool-btn">呼吸练习</button>
                <button class="tool-btn">正念冥想</button>
                <button class="tool-btn">情绪日记</button>
            </div>
            <div class="tool-section">
                <h4>自助资源</h4>
                <button class="tool-btn">应对策略</button>
                <button class="tool-btn">放松技巧</button>
                <button class="tool-btn">心理教育</button>
            </div>
            <div class="tool-section">
                <h4>深度思考</h4>
                <button class="tool-btn">UltraThink 模式</button>
                <button class="tool-btn">反思日记</button>
                <button class="tool-btn">认知重构</button>
            </div>
        </div>

        <div class="app-container" id="appContainer">
            <div class="chat-container" id="chatContainer">
                <div class="chat-header">
                    治疗会话
                </div>
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-message bot-message">
                        <div class="message-time">09:30</div>
                        你好！张明，欢迎回来。今天感觉怎么样？有什么想和我聊的吗？
                    </div>
                    <div class="chat-message user-message">
                        <div class="message-time">09:32</div>
                        你好，我最近工作压力有点大，晚上睡不好觉。
                    </div>
                    <div class="chat-message bot-message">
                        <div class="message-time">09:33</div>
                        我很抱歉听到你正经历这些压力。能具体和我说说工作上的哪些方面让你感到压力吗？这可能有助于我们一起找到应对方法。
                    </div>
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="输入你的消息...">
                    <button class="chat-btn-send" id="sendButton">➤</button>
                </div>
            </div>

        <!-- 工具页面容器 -->
        <div class="tool-page-container hidden" id="toolPageContainer">
            <div class="tool-page-header">
                <button class="back-btn" id="backBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                    返回
                </button>
                <h2 class="tool-page-title" id="toolPageTitle">工具页面</h2>
            </div>
            <div class="tool-page-content" id="toolPageContent"></div>
        </div>
    </div>

    <script>
        // DOM 元素
        const toolsToggle = document.getElementById('toolsToggle');
        const toolsSidebar = document.getElementById('toolsSidebar');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const chatMessages = document.getElementById('chatMessages');

        // 从localStorage获取用户会话数据
        let userSessionData = null;
        let isLoggedIn = false;

        function loadUserSession() {
            const storedData = localStorage.getItem('userSessionData');
            if (storedData) {
                try {
                    userSessionData = JSON.parse(storedData);
                    isLoggedIn = true;
                    
                    // 更新用户信息
                    const userName = document.querySelector('.user-name');
                    if (userName && userSessionData.username) {
                        userName.textContent = userSessionData.username;
                    }
                    
                    // 添加初始欢迎消息
                    const welcomeMessage = userSessionData.model_prompt || 
                        `你好！${userSessionData.username || '用户'}，欢迎回来。今天感觉怎么样？有什么想和我聊的吗？`;
                    
                    addBotMessage(welcomeMessage);
                    
                } catch (error) {
                    console.error('Failed to load user session:', error);
                    // 如果没有有效的会话数据，重定向到登录页
                    window.location.href = '/';
                }
            } else {
                // 如果没有会话数据，重定向到登录页
                window.location.href = '/';
            }
        }

        // 切换工具侧边栏
        let toolsVisible = false;
        toolsSidebar.style.display = 'none';

        toolsToggle.addEventListener('click', () => {
            toolsVisible = !toolsVisible;
            if (toolsVisible) {
                toolsSidebar.style.display = 'block';
                toolsToggle.textContent = '隐藏工具';
            } else {
                toolsSidebar.style.display = 'none';
                toolsToggle.textContent = '显示工具';
            }
        });

        // 添加消息到聊天界面
        function addUserMessage(message) {
            const userMessageElement = document.createElement('div');
            userMessageElement.classList.add('chat-message', 'user-message');
            const currentTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            userMessageElement.innerHTML = `<div class="message-time">${currentTime}</div>${message}`;
            chatMessages.appendChild(userMessageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addBotMessage(message) {
            const botMessageElement = document.createElement('div');
            botMessageElement.classList.add('chat-message', 'bot-message');
            const currentTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            botMessageElement.innerHTML = `<div class="message-time">${currentTime}</div>${message}`;
            chatMessages.appendChild(botMessageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showLoading() {
            const loadingElement = document.createElement('div');
            loadingElement.classList.add('chat-message', 'bot-message', 'loading');
            loadingElement.innerHTML = `<div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div><div class="typing-indicator">
                <span></span><span></span><span></span>
            </div>`;
            loadingElement.id = 'loadingMessage';
            chatMessages.appendChild(loadingElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return loadingElement;
        }

        function hideLoading() {
            const loadingElement = document.getElementById('loadingMessage');
            if (loadingElement) {
                chatMessages.removeChild(loadingElement);
            }
        }

        // 发送消息到后端
        function sendMessage() {
            const message = chatInput.value.trim();
            if (message === '') return;

            if (!userSessionData || !userSessionData.userID || !userSessionData.sessionID) {
                alert('会话信息无效，请重新登录');
                window.location.href = '/';
                return;
            }

            // 添加用户消息
            addUserMessage(message);

            // 清空输入框
            chatInput.value = '';

            // 显示加载状态
            showLoading();

            // 准备发送到后端的数据
            const requestData = {
                choice_info: {
                    user_id: userSessionData.userID,
                    session_id: userSessionData.sessionID,
                    user_choice: message,
                    input_type: "text"
                }
            };

            // 发送消息到后端
            fetch('http://localhost:5000/api/update_session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${userSessionData.token}`
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();

                if (data.success) {
                    // 添加机器人回复
                    addBotMessage(data.chatbot_response);
                    
                    // 如果有选项，可以在这里处理选项显示
                    if (data.user_options && data.user_options.length > 0) {
                        // 这里可以添加选项处理逻辑
                        console.log('Available options:', data.user_options);
                    }
                } else {
                    // 显示错误消息
                    addBotMessage(`抱歉，处理消息时出错：${data.error || '未知错误'}`);
                }
            })
            .catch(error => {
                hideLoading();
                addBotMessage('抱歉，连接服务器时出错。请稍后再试。');
                console.error('Error:', error);
            });
        }

        // 使用直接的聊天端点
        function sendChatMessage(message) {
            if (!userSessionData || !userSessionData.userID || !userSessionData.sessionID) {
                alert('会话信息无效，请重新登录');
                window.location.href = '/';
                return;
            }

            // 发送消息到聊天端点
            fetch('http://localhost:5000/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${userSessionData.token}`
                },
                body: JSON.stringify({
                    message: message,
                    session_id: userSessionData.sessionID
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addBotMessage(data.response);
                } else {
                    addBotMessage(`抱歉，处理消息时出错：${data.error || '未知错误'}`);
                }
            })
            .catch(error => {
                addBotMessage('抱歉，连接服务器时出错。请稍后再试。');
                console.error('Error:', error);
            });
        }

        // 点击发送按钮发送消息
        sendButton.addEventListener('click', sendMessage);

        // 按 Enter 键发送消息
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // 退出登录功能
        function handleLogout() {
            // 清除会话数据
            localStorage.removeItem('userSessionData');
            
            // 重定向到登录页
            window.location.href = '/';
        }

        // 添加退出登录事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            const logoutBtn = document.querySelector('.logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }
            
            // 加载用户会话
            loadUserSession();
        });

        // 工具按钮点击事件 - 跳转到对应页面
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.tool-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const toolName = this.textContent.trim();
                    
                    // 检查是否存在对应的工具页面
                    if (window.toolPages && window.toolPages[toolName]) {
                        // 隐藏聊天容器，显示工具页面容器
                        document.getElementById('chatContainer').classList.add('hidden');
                        document.getElementById('toolPageContainer').classList.remove('hidden');
                        
                        // 更新工具页面标题
                        document.getElementById('toolPageTitle').textContent = window.toolPages[toolName].title;
                        
                        // 更新工具页面内容
                        document.getElementById('toolPageContent').innerHTML = window.toolPages[toolName].content;
                    } else {
                        // 如果没有对应的工具页面，显示错误消息
                        const currentTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        const messageHtml = `
                        <div class="chat-message user-message">
                            <div class="message-time">${currentTime}</div>
                            我想使用${toolName}
                        </div>
                    `;
                    chatMessages.innerHTML += messageHtml;
                    chatMessages.scrollTop = chatMessages.scrollHeight;

                    // 模拟机器人回复
                    setTimeout(() => {
                        const botMessageHtml = `
                            <div class="chat-message bot-message">
                                <div class="message-time">${currentTime}</div>
                                抱歉，${toolName}功能暂未实现。
                            </div>
                        `;
                        chatMessages.innerHTML += botMessageHtml;
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }, 500);
                }
            });
        });

        // 返回按钮点击事件
        document.addEventListener('DOMContentLoaded', function() {
            const backButton = document.getElementById('backBtn');
            if (backButton) {
                backButton.addEventListener('click', function() {
                    // 隐藏工具页面容器，显示聊天容器
                    document.getElementById('toolPageContainer').classList.add('hidden');
                    document.getElementById('chatContainer').classList.remove('hidden');
                });
            }
        });
    });
    </script>

    <!-- 加载工具页面脚本 -->
    <script src="tool_pages.js"></script>
</body>
</html>