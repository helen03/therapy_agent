<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤©é—®é¢˜è¯Šæ–­</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .diagnostic-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .problem-indicator {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .problem {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .no-problem {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .unknown {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        #log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .chat-test {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }
        input[type="text"] {
            width: 70%;
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="diagnostic-container">
        <h1>ğŸ” èŠå¤©é—®é¢˜æ·±åº¦è¯Šæ–­</h1>
        
        <div class="section">
            <h2>1. åŸºç¡€è¿æ¥æµ‹è¯•</h2>
            <button onclick="testBackendConnection()">æµ‹è¯•åç«¯è¿æ¥</button>
            <button onclick="testFrontendConnection()">æµ‹è¯•å‰ç«¯è¿æ¥</button>
            <button onclick="testCORS()">æµ‹è¯•CORS</button>
            <div id="connection-status"></div>
        </div>
        
        <div class="section">
            <h2>2. ç™»å½•åŠŸèƒ½æµ‹è¯•</h2>
            <button onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
            <button onclick="testLoginWithWrongCredentials()">æµ‹è¯•é”™è¯¯ç™»å½•</button>
            <div id="login-status"></div>
        </div>
        
        <div class="section">
            <h2>3. èŠå¤©åŠŸèƒ½æµ‹è¯•</h2>
            <div class="chat-test">
                <h3>èŠå¤©æ¨¡æ‹Ÿå™¨</h3>
                <input type="text" id="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯..." value="æˆ‘æ„Ÿè§‰å¾ˆå¥½">
                <button onclick="sendChatMessage()">å‘é€æ¶ˆæ¯</button>
                <button onclick="testMultipleMessages()">æ‰¹é‡æµ‹è¯•</button>
                <div id="chat-response"></div>
            </div>
        </div>
        
        <div class="section">
            <h2>4. é—®é¢˜è¯Šæ–­</h2>
            <button onclick="diagnoseProblem()">å¼€å§‹è¯Šæ–­</button>
            <button onclick="checkJavaScriptErrors()">æ£€æŸ¥JavaScripté”™è¯¯</button>
            <button onclick="checkReactState()">æ£€æŸ¥ReactçŠ¶æ€</button>
            <div id="problem-diagnosis"></div>
        </div>
        
        <div class="section">
            <h2>5. è¯¦ç»†æ—¥å¿—</h2>
            <div id="log"></div>
            <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentSession = null;
        let diagnosticResults = {};
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            logDiv.textContent += logEntry + '\n';
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(logEntry);
        }
        
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const className = type === 'problem' ? 'problem-indicator problem' : 
                             type === 'no-problem' ? 'problem-indicator no-problem' : 
                             'problem-indicator unknown';
            element.innerHTML = `<div class="${className}">${message}</div>`;
        }
        
        async function testBackendConnection() {
            log('æµ‹è¯•åç«¯è¿æ¥...');
            try {
                const response = await fetch('http://localhost:5001/api/login', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Origin': 'http://localhost:3000'
                    },
                    body: JSON.stringify({ 
                        user_info: { username: 'user1', password: 'ph6n76gec9' } 
                    })
                });
                const data = await response.json();
                if (response.ok && data.success) {
                    showStatus('connection-status', 'âœ… åç«¯è¿æ¥æ­£å¸¸', 'no-problem');
                    log('åç«¯è¿æ¥æµ‹è¯•æˆåŠŸ');
                    log('å“åº”æ•°æ®:', JSON.stringify(data));
                } else {
                    showStatus('connection-status', `âŒ åç«¯è¿æ¥å¤±è´¥: ${response.status}`, 'problem');
                    log(`åç«¯è¿æ¥å¤±è´¥: ${response.status}`);
                    log('é”™è¯¯ä¿¡æ¯:', data.error || 'æœªçŸ¥é”™è¯¯');
                }
            } catch (error) {
                showStatus('connection-status', `âŒ åç«¯è¿æ¥å¼‚å¸¸: ${error.message}`, 'problem');
                log(`åç«¯è¿æ¥å¼‚å¸¸: ${error.message}`);
            }
        }
        
        async function testFrontendConnection() {
            log('æµ‹è¯•å‰ç«¯è¿æ¥...');
            try {
                const response = await fetch('http://localhost:3000');
                if (response.ok) {
                    showStatus('connection-status', 'âœ… å‰ç«¯è¿æ¥æ­£å¸¸', 'no-problem');
                    log('å‰ç«¯è¿æ¥æµ‹è¯•æˆåŠŸ');
                } else {
                    showStatus('connection-status', `âŒ å‰ç«¯è¿æ¥å¤±è´¥: ${response.status}`, 'problem');
                    log(`å‰ç«¯è¿æ¥å¤±è´¥: ${response.status}`);
                }
            } catch (error) {
                showStatus('connection-status', `âŒ å‰ç«¯è¿æ¥å¼‚å¸¸: ${error.message}`, 'problem');
                log(`å‰ç«¯è¿æ¥å¼‚å¸¸: ${error.message}`);
            }
        }
        
        async function testCORS() {
            log('æµ‹è¯•CORS...');
            try {
                const response = await fetch('http://localhost:5001/api/login', {
                    method: 'OPTIONS',
                    headers: { 
                        'Origin': 'http://localhost:3000',
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type'
                    }
                });
                const corsHeaders = response.headers.get('Access-Control-Allow-Origin');
                if (corsHeaders) {
                    showStatus('connection-status', 'âœ… CORSé…ç½®æ­£å¸¸', 'no-problem');
                    log('CORSæµ‹è¯•æˆåŠŸ');
                } else {
                    showStatus('connection-status', 'âŒ CORSé…ç½®æœ‰é—®é¢˜', 'problem');
                    log('CORSæµ‹è¯•å¤±è´¥');
                }
            } catch (error) {
                showStatus('connection-status', `âŒ CORSæµ‹è¯•å¼‚å¸¸: ${error.message}`, 'problem');
                log(`CORSæµ‹è¯•å¼‚å¸¸: ${error.message}`);
            }
        }
        
        async function testLogin() {
            log('æµ‹è¯•ç™»å½•åŠŸèƒ½...');
            try {
                const response = await fetch('http://localhost:5001/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_info: { username: 'user1', password: 'ph6n76gec9' }
                    })
                });
                const data = await response.json();
                if (data.success) {
                    currentUser = data.userID;
                    currentSession = data.sessionID;
                    showStatus('login-status', 
                        `âœ… ç™»å½•æˆåŠŸ<br>ç”¨æˆ·ID: ${data.userID}<br>ä¼šè¯ID: ${data.sessionID}`, 
                        'no-problem'
                    );
                    log('ç™»å½•æµ‹è¯•æˆåŠŸ');
                } else {
                    showStatus('login-status', `âŒ ç™»å½•å¤±è´¥: ${data.error}`, 'problem');
                    log(`ç™»å½•æµ‹è¯•å¤±è´¥: ${data.error}`);
                }
            } catch (error) {
                showStatus('login-status', `âŒ ç™»å½•å¼‚å¸¸: ${error.message}`, 'problem');
                log(`ç™»å½•å¼‚å¸¸: ${error.message}`);
            }
        }
        
        async function testLoginWithWrongCredentials() {
            log('æµ‹è¯•é”™è¯¯ç™»å½•...');
            try {
                const response = await fetch('http://localhost:5001/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_info: { username: 'wrong', password: 'wrong' }
                    })
                });
                const data = await response.json();
                if (!data.success) {
                    showStatus('login-status', 'âœ… é”™è¯¯ç™»å½•è¢«æ­£ç¡®æ‹’ç»', 'no-problem');
                    log('é”™è¯¯ç™»å½•æµ‹è¯•æˆåŠŸ - è¢«æ­£ç¡®æ‹’ç»');
                } else {
                    showStatus('login-status', 'âŒ é”™è¯¯ç™»å½•è¢«é”™è¯¯æ¥å—', 'problem');
                    log('é”™è¯¯ç™»å½•æµ‹è¯•å¤±è´¥ - è¢«é”™è¯¯æ¥å—');
                }
            } catch (error) {
                showStatus('login-status', `âŒ é”™è¯¯ç™»å½•æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'problem');
                log(`é”™è¯¯ç™»å½•æµ‹è¯•å¼‚å¸¸: ${error.message}`);
            }
        }
        
        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) {
                log('è¯·è¾“å…¥æ¶ˆæ¯');
                return;
            }
            
            if (!currentUser || !currentSession) {
                log('è¯·å…ˆç™»å½•');
                return;
            }
            
            log(`å‘é€æ¶ˆæ¯: ${message}`);
            
            try {
                const response = await fetch('http://localhost:5001/api/update_session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        choice_info: {
                            user_id: currentUser,
                            session_id: currentSession,
                            user_choice: message
                        }
                    })
                });
                
                const data = await response.json();
                log(`æ”¶åˆ°å“åº”: ${JSON.stringify(data)}`);
                
                if (data.chatbot_response) {
                    document.getElementById('chat-response').innerHTML = 
                        `<div style="background: #e8f5e8; padding: 10px; border-radius: 4px; margin: 10px 0;">
                            <strong>æœºå™¨äººå›å¤:</strong> ${data.chatbot_response}
                        </div>`;
                    log('èŠå¤©æ¶ˆæ¯å‘é€æˆåŠŸ');
                } else {
                    document.getElementById('chat-response').innerHTML = 
                        `<div style="background: #ffe8e8; padding: 10px; border-radius: 4px; margin: 10px 0;">
                            <strong>é”™è¯¯:</strong> ${data.error || 'æœªçŸ¥é”™è¯¯'}
                        </div>`;
                    log(`èŠå¤©æ¶ˆæ¯å‘é€å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                document.getElementById('chat-response').innerHTML = 
                    `<div style="background: #ffe8e8; padding: 10px; border-radius: 4px; margin: 10px 0;">
                        <strong>å¼‚å¸¸:</strong> ${error.message}
                    </div>`;
                log(`èŠå¤©æ¶ˆæ¯å‘é€å¼‚å¸¸: ${error.message}`);
            }
        }
        
        async function testMultipleMessages() {
            const messages = ['æˆ‘æ„Ÿè§‰å¾ˆå¥½', 'Continue', 'Happy', 'æˆ‘æƒ³èŠèŠå·¥ä½œ'];
            
            for (let i = 0; i < messages.length; i++) {
                document.getElementById('chat-input').value = messages[i];
                await sendChatMessage();
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }
        
        async function diagnoseProblem() {
            log('å¼€å§‹é—®é¢˜è¯Šæ–­...');
            document.getElementById('problem-diagnosis').innerHTML = '<div>è¯Šæ–­ä¸­...</div>';
            
            const problems = [];
            
            // 1. æ£€æŸ¥åç«¯è¿æ¥
            try {
                const response = await fetch('http://localhost:5001/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ test: 'connection' })
                });
                if (!response.ok) {
                    problems.push('åç«¯è¿æ¥å¤±è´¥');
                }
            } catch (error) {
                problems.push('åç«¯è¿æ¥å¼‚å¸¸: ' + error.message);
            }
            
            // 2. æ£€æŸ¥ç™»å½•åŠŸèƒ½
            try {
                const loginResponse = await fetch('http://localhost:5001/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_info: { username: 'user1', password: 'ph6n76gec9' }
                    })
                });
                const loginData = await loginResponse.json();
                if (!loginData.success) {
                    problems.push('ç™»å½•åŠŸèƒ½å¤±è´¥');
                }
            } catch (error) {
                problems.push('ç™»å½•åŠŸèƒ½å¼‚å¸¸: ' + error.message);
            }
            
            // 3. æ£€æŸ¥èŠå¤©åŠŸèƒ½
            try {
                if (currentUser && currentSession) {
                    const chatResponse = await fetch('http://localhost:5001/api/update_session', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            choice_info: {
                                user_id: currentUser,
                                session_id: currentSession,
                                user_choice: 'test'
                            }
                        })
                    });
                    const chatData = await chatResponse.json();
                    if (!chatData.chatbot_response) {
                        problems.push('èŠå¤©åŠŸèƒ½æ— å“åº”');
                    }
                } else {
                    problems.push('ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•æµ‹è¯•èŠå¤©åŠŸèƒ½');
                }
            } catch (error) {
                problems.push('èŠå¤©åŠŸèƒ½å¼‚å¸¸: ' + error.message);
            }
            
            // 4. æ˜¾ç¤ºè¯Šæ–­ç»“æœ
            if (problems.length === 0) {
                document.getElementById('problem-diagnosis').innerHTML = 
                    '<div class="problem-indicator no-problem">âœ… æœªå‘ç°æ˜æ˜¾é—®é¢˜ï¼Œå¯èƒ½éœ€è¦æ£€æŸ¥å‰ç«¯JavaScriptä»£ç </div>';
                log('è¯Šæ–­å®Œæˆï¼šæœªå‘ç°æ˜æ˜¾é—®é¢˜');
            } else {
                const problemList = problems.map(p => `â€¢ ${p}`).join('<br>');
                document.getElementById('problem-diagnosis').innerHTML = 
                    `<div class="problem-indicator problem">âŒ å‘ç°ä»¥ä¸‹é—®é¢˜ï¼š<br>${problemList}</div>`;
                log(`è¯Šæ–­å®Œæˆï¼šå‘ç°é—®é¢˜ - ${problems.join(', ')}`);
            }
        }
        
        function checkJavaScriptErrors() {
            log('æ£€æŸ¥JavaScripté”™è¯¯...');
            
            // æ£€æŸ¥å…¨å±€é”™è¯¯
            window.onerror = function(message, source, lineno, colno, error) {
                log(`JavaScripté”™è¯¯: ${message} at ${source}:${lineno}:${colno}`);
                return true;
            };
            
            // æ£€æŸ¥æœªå¤„ç†çš„Promiseæ‹’ç»
            window.onunhandledrejection = function(event) {
                log(`Promiseæ‹’ç»: ${event.reason}`);
            };
            
            // æ£€æŸ¥Reactå¼€å‘è€…å·¥å…·
            if (window.__REACT_DEVTOOLS_GLOBAL_HOOK__) {
                log('Reactå¼€å‘è€…å·¥å…·å·²å®‰è£…');
            } else {
                log('Reactå¼€å‘è€…å·¥å…·æœªå®‰è£…');
            }
            
            // æ£€æŸ¥consoleé”™è¯¯
            const originalError = console.error;
            console.error = function(...args) {
                log(`Consoleé”™è¯¯: ${args.join(' ')}`);
                originalError.apply(console, args);
            };
            
            document.getElementById('problem-diagnosis').innerHTML = 
                '<div class="problem-indicator unknown">âš ï¸ JavaScripté”™è¯¯æ£€æŸ¥å·²å¯ç”¨ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°</div>';
        }
        
        function checkReactState() {
            log('æ£€æŸ¥ReactçŠ¶æ€...');
            
            // å°è¯•è®¿é—®Reactç»„ä»¶
            if (window.__REACT_DEVTOOLS_GLOBAL_HOOK__) {
                const reactRoot = document.querySelector('#root');
                if (reactRoot) {
                    log('Reactæ ¹å…ƒç´ æ‰¾åˆ°');
                    // å°è¯•è·å–Reactç»„ä»¶å®ä¾‹
                    try {
                        const fiberKey = Object.keys(reactRoot).find(key => key.startsWith('__reactInternalInstance'));
                        if (fiberKey) {
                            log('React Fiberå®ä¾‹æ‰¾åˆ°');
                        } else {
                            log('React Fiberå®ä¾‹æœªæ‰¾åˆ°');
                        }
                    } catch (error) {
                        log(`ReactçŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`);
                    }
                } else {
                    log('Reactæ ¹å…ƒç´ æœªæ‰¾åˆ°');
                }
            } else {
                log('Reactå¼€å‘è€…å·¥å…·æœªæ‰¾åˆ°ï¼Œæ— æ³•æ£€æŸ¥çŠ¶æ€');
            }
            
            document.getElementById('problem-diagnosis').innerHTML = 
                '<div class="problem-indicator unknown">âš ï¸ ReactçŠ¶æ€æ£€æŸ¥å®Œæˆï¼Œè¯·æŸ¥çœ‹æ—¥å¿—</div>';
        }
        
        function clearLog() {
            document.getElementById('log').textContent = '';
            log('æ—¥å¿—å·²æ¸…é™¤');
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å¼€å§‹è¯Šæ–­
        window.onload = function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œè¯Šæ–­å·¥å…·å·²å°±ç»ª');
            log('å»ºè®®æŒ‰é¡ºåºè¿›è¡Œæµ‹è¯•ï¼š');
            log('1. æµ‹è¯•åŸºç¡€è¿æ¥');
            log('2. æµ‹è¯•ç™»å½•åŠŸèƒ½');
            log('3. æµ‹è¯•èŠå¤©åŠŸèƒ½');
            log('4. å¼€å§‹é—®é¢˜è¯Šæ–­');
        };
    </script>
</body>
</html>