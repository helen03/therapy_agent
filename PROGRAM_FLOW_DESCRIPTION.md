# Therapy Agent (SATbot) 程序执行说明与聊天控制流程

## 项目概述

Therapy Agent（也称为SATbot）是一个基于人工智能的治疗辅助聊天机器人应用程序，旨在通过结构化的对话流程提供情感支持和治疗练习指导。该应用结合了前端React界面与后端Flask服务，实现了用户认证、会话管理、记忆集成和基于规则的响应生成等核心功能。

## 整体架构

该项目采用前后端分离的架构设计：

1. **前端 (Frontend)**
   - 基于React框架开发
   - 使用react-chatbot-kit库实现聊天界面
   - 通过Axios与后端API通信
   - 负责用户交互和界面展示

2. **后端 (Backend)**
   - 基于Flask框架开发
   - 提供RESTful API接口
   - 集成SQLAlchemy进行数据库操作
   - 包含基于规则的决策模型
   - 实现记忆管理系统

3. **数据存储**
   - 使用SQLite数据库存储用户信息和会话记录
   - 通过Flask-Migrate管理数据库迁移

## 聊天控制流程详解

### 1. 初始化与用户认证流程

```
用户打开应用 → 前端加载并显示欢迎消息 → 请求用户输入用户名和密码 → 
发送认证请求到后端 → 后端验证凭据 → 返回认证结果 → 
认证成功则开始会话，失败则提示用户重新输入
```

**前端关键实现：**
- `config.js`中的`initialMessages`定义了初始欢迎消息序列
- `MessageParser.js`处理用户输入，在认证阶段调用`actionProvider.askForPassword`和`actionProvider.updateUserID`
- `ActionProvider.js`中的`updateUserID`方法向后端发送认证请求

**后端关键实现：**
- `__init__.py`中的`/api/login`路由处理认证请求
- 验证用户名和密码，并为成功认证的用户创建新会话
- 返回初始模型提示和可选操作

### 2. 会话交互流程

认证成功后，系统进入会话交互阶段，核心流程如下：

```
用户输入或选择回复 → 前端MessageParser解析输入 → 
ActionProvider发送请求到后端 → 后端处理请求并生成响应 → 
返回聊天机器人回复和可选操作 → 前端展示回复并提供相应交互选项
```

**前端关键组件：**

1. **MessageParser (消息解析器)**
   - 核心功能：分析用户输入并确定后续操作
   - 根据当前状态（是否要求协议选择、当前等待的输入类型等）进行不同处理
   - 验证用户输入是否符合预期格式
   
2. **ActionProvider (动作提供者)**
   - 核心功能：处理各种交互动作并与后端通信
   - 管理会话状态更新
   - 调用API发送用户选择并接收响应
   - 根据响应类型展示不同的交互组件（按钮、选项等）
   
3. **配置组件 (config.js)**
   - 定义聊天机器人的基本配置
   - 设置初始消息序列
   - 配置可用的交互组件（widgets）

**后端处理流程：**

1. `__init__.py`中的`/api/update_session`路由接收用户选择
2. 将会话数据存储到记忆管理系统
3. 调用`decision_maker.save_current_choice`保存用户选择
4. 调用`decision_maker.determine_next_choice`生成下一个问题/响应
5. 使用记忆管理系统增强响应内容
6. 返回聊天机器人回复和可选操作

### 3. 基于规则的决策模型

`ModelDecisionMaker`类是聊天控制的核心，负责：

- 存储和管理治疗练习方案（26种不同的练习）
- 根据用户输入和会话历史确定下一步操作
- 管理用户选择和会话状态
- 生成适当的模型提示和用户选项

### 4. 记忆集成系统

项目集成了记忆管理功能，通过`memory_manager`实现：

- 存储用户会话记录和选择
- 提供上下文感知的响应增强
- 支持个性化的交互体验

## 程序执行流程

### 启动流程

1. **后端启动**
   - 通过`start_backend.py`脚本启动Flask应用
   - 初始化数据库连接和CORS配置
   - 注册API路由
   - 启动Web服务器

2. **前端启动**
   - 执行`npm run start`启动React开发服务器
   - 加载聊天组件和配置
   - 连接到后端API

### 主要功能模块

1. **用户认证模块**
   - 提供用户名/密码验证
   - 支持访客登录选项
   - 为认证用户创建会话

2. **会话管理模块**
   - 跟踪用户会话状态
   - 管理用户选择历史
   - 确保对话流程的连贯性

3. **响应生成模块**
   - 基于规则生成聊天机器人回复
   - 根据用户输入调整对话方向
   - 提供适当的交互选项

4. **记忆增强模块**
   - 存储和检索用户会话历史
   - 利用历史数据增强当前响应
   - 提供个性化的治疗体验

## 前端交互组件

应用程序包含多种交互组件（widgets）以支持不同类型的用户输入：

- **YesNoOptions**：提供是/否选项
- **ContinueOptions**：提供继续选项
- **EmotionOptions**：提供情感选择（积极/中性/消极）
- **FeedbackOptions**：提供反馈选项（更好/更差/无变化）
- **ProtocolOptions**：提供治疗方案选择
- **YesNoProtocolOptions**：提供与方案相关的是/否选项
- **EventOptions**：提供事件时间选择（近期/远期）

## 数据流程

1. **用户输入 → 前端处理 → API请求 → 后端处理 → 数据库更新 → 响应生成 → API响应 → 前端展示**

2. **用户选择**通过`/api/update_session`端点发送到后端，后端将其存储在数据库中，并使用`ModelDecisionMaker`确定下一个响应，然后返回给前端展示给用户。

## 关键文件说明

- **前端核心文件**
  - `App.js`：应用主组件，集成聊天机器人
  - `MessageParser.js`：解析用户输入并确定操作
  - `ActionProvider.js`：处理交互动作并与后端通信
  - `config.js`：配置聊天机器人行为和界面

- **后端核心文件**
  - `__init__.py`：Flask应用创建和API路由定义
  - `rule_based_model.py`：基于规则的决策模型
  - `memory_integration.py`：记忆管理系统
  - `models.py`：数据模型定义
  - `flask_backend_with_aws.py`：后端启动脚本

- **启动辅助文件**
  - `start_backend.py`：简化的后端启动脚本
  - `start_all.sh`：一键启动脚本
  - `STARTUP_GUIDE.md`：启动注意事项文档

## 运行环境与依赖

- **前端**
  - Node.js 14+（v17+需要特殊配置）
  - React 17.0.2
  - react-chatbot-kit 1.1.20
  - Axios

- **后端**
  - Python 3.7+（推荐3.9）
  - Flask
  - SQLAlchemy
  - Pandas, NumPy
  - NLTK

## 使用说明

1. 使用提供的一键启动脚本启动应用：`./start_all.sh`
2. 在浏览器中访问 `http://localhost:3000`
3. 使用提供的用户名和密码登录（或使用guest/guest）
4. 按照聊天机器人的引导进行交互
5. 根据提示选择或输入相应的回复

## 总结

Therapy Agent (SATbot) 是一个功能完整的治疗辅助聊天机器人应用，通过精心设计的聊天控制流程和基于规则的决策模型，为用户提供结构化的治疗体验。该应用采用现代的前后端分离架构，具有良好的可扩展性和可维护性，可以作为情感支持和治疗辅助工具使用。